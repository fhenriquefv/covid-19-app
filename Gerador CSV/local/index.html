<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps API</title>
    <style>
        #map{
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<body>

    Raio de busca (em metros): <input type="number" name="radius" id="radius">
    Filtro: <select name="filtro" id="filtro">
        <option value="stadium">Estádios</option>
        <option value="hospital">Hospitais</option>
    </select>

    <button id="submit" onclick="ajax()">Gerar CSV</button>


    <h1>Mapa (clique com o botão esquerdo do mouse adicionar os estabelecimentos na lista)</h1>
    <div id="map"></div>

    <script src="js/axios.js"></script>
    <script>

        /*document.body.onload = async e => {
            const resultado = await axios("http://localhost:3300/refri")
                .catch(err => console.log(err))
            console.log(resultado)
        }*/

        let map = null
        let infowindow = null
        let request = null
        let service = null
        let markers = []
        let filtro = null
        const busca = []
        function initMap() {

            const center = {lat: -22.9035 , lng: -43.2096}
            const div = document.querySelector('div#map')
            map = new google.maps.Map(div, {
                zoom: 10,
                center: center
            })

            /*request = { 
                location: center,
                radius: 100000,
                types: ['stadium']
            }*/

            infowindow = new google.maps.InfoWindow()
            service = new google.maps.places.PlacesService(map)


            //service.nearbySearch(request, callback)

            google.maps.event.addListener(map, 'rightclick', event => {
                let radius = parseFloat(document.querySelector('input#radius').value)
                let select = document.querySelector('select#filtro')
                filtro = select.options[select.selectedIndex].value
                let param = filtro
                //console.log(filtro, radius)
                map.setCenter(event.latLng)
                clearResults(markers)
                request = {
                    fields: ['name', 'vicinity', 'plus_code'],
                    location: event.latLng,
                    radius: radius,
                    types: [filtro]
                }

                service.nearbySearch(request, callback)

            })
        }

        async function callback(results, status) {
            if(status == google.maps.places.PlacesServiceStatus.OK) {
                
                //console.log(results)
                results.forEach(place => {
                    //console.log(place)
                    markers.push(createMarker(place))
                    let existe = busca.find(element => element.id === place.id)
                    console.log(existe)
                    if(!existe) {
                        busca.push(place)
                    }else {
                        console.log('Já existe')
                    }
                })
                console.log(busca)
                
                /*const resposta = await axios.post('/construirCSV', {lugares: results, filtro})
                console.log(resposta)
                alert(resposta.data)*/
            }
        }

        function createMarker(place) {
            const placeLoc = place.geometry.location
            const marker = new google.maps.Marker({
                map: map,
                position: placeLoc
            })

            google.maps.event.addListener(marker, 'click', () => {
                infowindow.setContent(place.name)
                infowindow.open(map, marker)
            })
            return marker
        }

        function clearResults(markers){
            markers.forEach(marker => marker.setMap(null))
            markers = []
        }

        async function ajax() {
            const resposta = await axios.post('http://localhost:3000/construirCSV', {lugares: busca})
                console.log(resposta)
                alert(resposta.data)
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?libraries=places&key=AIzaSyBofqU_V-dLDeMwfha5K8RcYwxwABYD_tY&callback=initMap"
    type="text/javascript"></script>
    
</body>
</html>